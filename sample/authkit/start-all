#/bin/bash

echo "Don't execute this file, use snippets from it"
less ./start-all
exit 1

# 1. start hydra

sudo docker run -d \
    -p 4444:4444 \
    --name my-hydra \
    -e "CONSENT_URL=https://localhost:8080/login" \
    oryam/hydra

# 2. get client_id and client_secret of default client from logs (to connect to Hydra with CLI)

sudo docker logs my-hydra

# 3. create client for test

sudo docker exec -i -t my-hydra /bin/bash

hydra connect --skip-tls-verify

hydra clients create -n "test" \
  -c [https://localhost:8080/callback] \
  -g [authorization_code,client_credentials,refresh_token] \
  -r [code,token] \
  -a [core,hydra.keys.get,hydra.warden,offline,test.profile.edit,test.friends.view] \
  --skip-tls-verify

hydra policies create --allow -r "rn:hydra:keys:<[^:]+>:public" -s "<.*>" -a "get" --skip-tls-verify
hydra policies create --allow -r "rn:hydra:keys:<[^:]+>:private" -s "<.*>" -a "get" --skip-tls-verify
hydra policies create --allow -r "rn:hydra:warden:token:allowed" -s "<.*>" -a "decide" --skip-tls-verify

hydra policies create --allow -r "rn:api" -s "<.*>" -a "get" --skip-tls-verify
hydra policies create --allow -r "rn:api:friends" -s "<.*>" -a "get" --skip-tls-verify
hydra policies create --allow -r "rn:api:profile" -s "<.*>" -a "edit" --skip-tls-verify

exit

# 4. put returned client_id and client_secret into dev.yml

# 5. start DB

sudo docker run -d \
    -p 27017:27017 \
    --name mongo-hydra-sample \
    mongo

# 6. run ui-app

cd ui-web/
rm -rf dist
npm run dist
cd ../backend

go run main.go

# 7. start from page like this (in firefox!, use client_id from #3):
# NOTE: if you use client_id from step 3, browser will be finally redirected to
# the internal callback, which will reject arbitrary state values.
# You should create another client for external app with redirect url of that
# app, so that it be able to exchange code to access token and made requests
# to hydra-sample's API with that token.
#
# https://localhost:8080/oauth2/auth?client_id=xxx&response_type=code&scope=core+hydra.keys.get&state=vboeidlizlxrywkwlsgeggff
#
