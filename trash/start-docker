#/bin/bash

# 1. start hydra

sudo docker run -d \
    -p 4444:4444 \
    --name my-hydra \
    -e "CONSENT_URL=http://localhost:3000" \
    oryam/hydra

# 2. get client_id and client_secret of default client from logs (to connect to Hydra with CLI)

sudo docker logs my-hydra

# 3. create client for test

sudo docker exec -i -t my-hydra /bin/bash

hydra connect --skip-tls-verify

hydra clients create -n "test" \
  -c [http://localhost:3000/callback] \
  -g [authorize_code,authorization_code,client_credentials] \
  -r [code,token] \
  -a [core,hydra.keys.get] \
  --skip-tls-verify

hydra policies create --allow -r "rn:hydra:keys:<[^:]+>:public" -s "<.*>" -a "get" --skip-tls-verify

hydra policies create --allow -r "rn:hydra:keys:<[^:]+>:private" -s "<.*>" -a "get" --skip-tls-verify

exit

# 4. put returned client_id and client_secret into ./hydra.yml

# 5. run ui-app

sudo docker run -d -p 3000:3000 \
    -v $(readlink -f hydra.yml):/root/.hydra.yml \
    -e "NODE_TLS_REJECT_UNAUTHORIZED=0" \
    --link my-hydra \
    --name my-hydra-consent-ui \
    oryam/hydra-idp-react


# 6. start from page like this (in firefox!, use client_id from #3):
#
# https://localhost:4444/oauth2/auth?client_id=xxx&response_type=code&scope=core+hydra.keys.get&state=vboeidlizlxrywkwlsgeggff&nonce=tedgziijemvninkuotcuuiof
#
