import urlParams from '../util/url-params.js';
import 'whatwg-fetch';
import respHelper from '../util/response-helper';

<login>
    <div class="modal"
         tabindex="-1"
         role="dialog"
         onclick="{ close }">
        <div class="modal-dialog">
            <div name="modalContent"
                class="modal-content"
                style="{ contentStyle() }"
                onclick="{ onModalContentClick }">
                <div name="modalHeader"
                    class="modal-header">
                    <button type="button"
                            class="close"
                            onclick="{ close }"><span>&times;</span></button>
                    <h4 class="modal-title">Login</h4>
                </div>
                <div name="modalBody"
                    class="modal-body"
                    style="{ modalBodyStyle() }">
                    <error-msg error="{ error }" />
                    <div style="text-align:center">
                        <form id="login-form">
                            <input type="text"
                                class="form-control"
                                name="login"
                                placeholder="User name or email"/>
                            <input type="password" 
                                class="form-control"
                                name="password"
                                placeholder="Password"/>
                            <button type="submit"
                                    class="btn btn-default"
                                    name="login"
                                    onclick="{ onLogin }" >Login</button>
                            <button type="submit"
                                    class="btn btn-default"
                                    name="signup">Sign Up</button>
                        </form>
                        <br/>
                        <a href="#">Forget password?</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let self = this;
        self.error = urlParams.get("error_description");
        let challenge = urlParams.get("challenge");
        if (!self.error && !challenge) {
            self.error = "Could not authenticate.";
        }
        self.close = () => {
        }
        self.onModalContentClick = (e) => {
            e.stopPropagation();
            return true;
        }
        self.onLogin = () => {
            let form = new FormData(document.getElementById('login-form'));
            if (challenge) {
                form.append('challenge', challenge);
            }
            fetch("/api/login", {
                method: "POST",
                body: form
            })
            .then(r => {
                return respHelper.handleStatus(r);
            })
            .then(data => {
                
                const {challenge, authenticated, error} = data;
                if (!authenticated) {
                    self.error = "Could not authenticate. ";
                }
                if (error) {
                    self.error += error;
                }
                //TODO
                console.log("resp on /api/login:", data, challenge, authenticated, error)
                self.update();
            })
            .catch(e => {
                console.log(e);
            });
        }
    </script>
</login>
